#!/bin/bash

set -eu

basic_setup() {
    if [ "${CHOCPKG_ROOT:-}" = "" ]; then
        echo "CHOCPKG_ROOT not configured - please source setup.sh." \
            >> /dev/stderr
        exit -1
    fi
    INSTALL_DIR="$CHOCPKG_ROOT/install"
    NATIVE_INSTALL_DIR="$CHOCPKG_ROOT/install.native"
    PACKAGES_DIR="$CHOCPKG_ROOT/packages"
    BUILD_DIR="$CHOCPKG_ROOT/build"
    mkdir -p "$INSTALL_DIR" "$NATIVE_INSTALL_DIR" "$PACKAGES_DIR" "$BUILD_DIR"
}

basic_setup

. chocpkg_functions.sh
. chocpkg_modules.sh
. "$CHOCPKG_ROOT/buildenv.sh"

dependencies() {
    DEPENDENCIES="$*"
}

# Given a package name, find the pkgdef file associated with it, source
# the contents of the file and set various variables.
configure_for_package() {
    local package=$1
    local pkg_file="$CHOCPKG_ROOT/pkgdef/$package.sh"
    if [ ! -e "$pkg_file" ]; then
        error_exit "Package file $package.sh not found."
    fi
    # Defaults for package unless overridden:
    PACKAGE_NAME=$package
    PACKAGE_TYPE=target
    DEPENDENCIES=""
    . "$pkg_file"

    PACKAGE_BUILD_DIR="$BUILD_DIR/$PACKAGE_NAME"
    if [ "${PACKAGE_VERSION:-}" != "" ]; then
        PACKAGE_BUILD_DIR="$PACKAGE_BUILD_DIR-$PACKAGE_VERSION"
    fi

    # We set up build differently depending on the package type: some packages
    # are for the target we're building for; others are native tools to run on
    # the build machine as part of the build process.
    case "$PACKAGE_TYPE" in
        target)
            PACKAGE_INSTALL_DIR="$INSTALL_DIR"
            ;;
        native)
            PACKAGE_INSTALL_DIR="$NATIVE_INSTALL_DIR"
            ;;
        *)
            error_exit "Unknown package type $PACKAGE_TYPE"
            ;;
    esac

    # We must set PKG_CONFIG_PATH now so we know where to look for packages.
    PKG_CONFIG_PATH="$PACKAGE_INSTALL_DIR/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
    export PKG_CONFIG_PATH

    # When cross-compiling, reconfigure pkg-config to not look for .pc
    # files in the standard system directories; only in our own build
    # directory. It may be that a library is installed on the system
    # but that is useless if it is for the wrong architecture.
    if $IS_CROSS_COMPILE && [ "$PACKAGE_TYPE" = "target" ]; then
        export PKG_CONFIG_LIBDIR=
    fi
}

fetch_package() {
    do_fetch
}

setup_build_environment() {
    CPPFLAGS="-I$PACKAGE_INSTALL_DIR/include"
    LDFLAGS="-L$PACKAGE_INSTALL_DIR/lib ${LDFLAGS:-}"
    export CPPFLAGS LDFLAGS

    # ACLOCAL_PATH is a special case: we include the aclocal paths from both
    # target and native, so that it is possible to get the pkg-config macros.
    ACLOCAL_PATH="$INSTALL_DIR/share/aclocal:${ACLOCAL_PATH:-}"
    ACLOCAL_PATH="$NATIVE_INSTALL_DIR/share/aclocal:$ACLOCAL_PATH"
    export ACLOCAL_PATH
}

install_dependencies() {
    for dep in $DEPENDENCIES; do
        chocpkg install "$dep"
    done
}

# Function invoked before a package is built to set up the build environment,
# if necessary. Can be overridden by pkgdef files.
prebuild_setup() {
    true
}

build_package() {
    install_dependencies
    fetch_package "$PACKAGE_NAME"

    echo =======================================================
    echo "Building $PACKAGE_NAME..."
    echo =======================================================
    echo
    cd "$PACKAGE_BUILD_DIR"

    setup_build_environment

    if ! prebuild_setup; then
        error_exit "Failed pre-build setup step for $PACKAGE_NAME."
    fi

    do_build
}

reinstall_package() {
    build_package "$PACKAGE_NAME"
    cd "$PACKAGE_BUILD_DIR"
    do_install
}

install_package() {
    # Already installed? Don't install again.
    if ! check_installed; then
        reinstall_package
    fi
}

if [ $# -lt 2 ]; then
    echo "Usage: $0 [fetch|build|install|installed] <package name>"
    exit -1
fi

cmd=$1; package=$2
configure_for_package "$package"

case "$cmd" in
    fetch)
        fetch_package
        ;;
    build)
        build_package
        ;;
    reinstall)
        reinstall_package
        ;;
    install)
        install_package
        ;;
    installed)
        check_installed
        ;;
esac

